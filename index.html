<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Genesys Cloud Workitem Creator</title>
  <script>
    async function loadWorktypes() {
      const resp = await fetch('/api/worktypes');
      const worktypes = await resp.json();
      const select = document.getElementById('worktypeSelect');
      select.innerHTML = '';
      worktypes.forEach(wt => {
        const option = document.createElement('option');
        option.value = wt.id;
        option.text = wt.name;
        select.appendChild(option);
      });
    }

    async function loadSchema() {
      const worktypeId = document.getElementById('worktypeSelect').value;
      if (!worktypeId) return;
      const resp = await fetch(`/api/worktypes/${worktypeId}/schema`);
      const schema = await resp.json();
      renderSchemaForm(schema);
    }

    function renderSchemaForm(schema) {
      const formDiv = document.getElementById('attributesForm');
      formDiv.innerHTML = '';
      schema.attributes.forEach(attr => {
        let input;
        switch (attr.type) {
          case 'integer':
            input = `<input type="number" name="${attr.name}" required>`;
            break;
          case 'datetime':
            input = `<input type="datetime-local" name="${attr.name}" required>`;
            break;
          default:
            input = `<input type="text" name="${attr.name}" required>`;
        }
        formDiv.innerHTML += `<label>${attr.name}: ${input}</label><br>`;
      });
      formDiv.innerHTML += `<button onclick="createWorkitem()">Create Workitem</button>`;
    }

    async function createWorkitem() {
      const worktypeId = document.getElementById('worktypeSelect').value;
      const formDiv = document.getElementById('attributesForm');
      const inputs = formDiv.querySelectorAll('input');
      let attributeValues = {};
      inputs.forEach(input => {
        attributeValues[input.name] = input.value;
      });

      const payload = {
        worktypeId,
        attributeValues
      };

      const resp = await fetch('/api/workitems', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await resp.json();
      alert('Workitem created: ' + JSON.stringify(result));
    }

    window.onload = loadWorktypes;
  </script>
</head>
<body>
  <h1>Create Genesys Cloud Workitem</h1>
  <div>
    <label>Select Worktype:</label>
    <select id="worktypeSelect" onchange="loadSchema()"></select>
  </div>
  <hr>
  <div id="attributesForm"></div>
</body>
</html>